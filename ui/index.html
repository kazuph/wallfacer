<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wallfacer â€” Kanban</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/styles.css">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@9/marked.min.js"></script>
</head>
<body class="h-screen overflow-hidden flex flex-col">

<!-- Theme init (before render to prevent flash) -->
<script>
(function() {
  var mode = localStorage.getItem('wallfacer-theme') || 'auto';
  var dark = mode === 'dark' || (mode === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
  document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
})();
</script>

<!-- Header -->
<header style="border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;">
  <div style="display: flex; align-items: center; gap: 16px;">
    <h1 style="font-size: 22px; font-weight: 400; letter-spacing: 0.01em; margin: 0; font-family: 'Instrument Serif', Georgia, serif; font-style: italic; background: linear-gradient(135deg, #d97757 0%, #c4623f 60%, #a84e2e 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Wallfacer</h1>
    <div id="workspace-list" style="display: flex; gap: 6px; flex-wrap: wrap;"></div>
  </div>
  <div style="position: relative;">
    <button id="settings-btn" class="settings-btn" onclick="toggleSettings(event)" title="Settings">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    </button>
    <div id="settings-panel" class="settings-panel hidden">
      <div style="margin-bottom: 8px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Theme</div>
      <div class="theme-switch" id="theme-switch">
        <button data-mode="light" onclick="setTheme('light')">Light</button>
        <button data-mode="dark" onclick="setTheme('dark')">Dark</button>
        <button data-mode="auto" onclick="setTheme('auto')">Auto</button>
      </div>
      <div style="margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px;">
        <div style="margin-bottom: 8px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Done Column</div>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; color: var(--text-secondary);">
          <input type="checkbox" id="show-archived-toggle" onchange="toggleShowArchived()" style="cursor: pointer; accent-color: var(--accent);">
          Show archived tasks
        </label>
      </div>
      <div style="margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px;">
        <div style="margin-bottom: 8px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">CLAUDE.md</div>
        <div style="display: flex; gap: 6px;">
          <button onclick="showInstructionsEditor(event)" class="btn-icon" style="font-size: 12px; padding: 4px 10px;">Edit</button>
          <button onclick="reinitInstructions()" class="btn-icon" style="font-size: 12px; padding: 4px 10px;">Re-init</button>
        </div>
        <div style="margin-top: 6px; font-size: 11px; color: var(--text-muted); line-height: 1.4;">Workspace instructions for Claude Code. Re-init merges the default template with each repo's CLAUDE.md.</div>
      </div>
      <div style="margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px;">
        <div style="margin-bottom: 8px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Task Titles</div>
        <div style="display: flex; gap: 6px; align-items: center;">
          <select id="generate-titles-limit" class="select" style="font-size: 12px; padding: 3px 6px; height: auto;" title="Max tasks to generate titles for">
            <option value="5">5 tasks</option>
            <option value="10" selected>10 tasks</option>
            <option value="25">25 tasks</option>
            <option value="50">50 tasks</option>
            <option value="0">All</option>
          </select>
          <button onclick="generateMissingTitles()" class="btn-icon" style="font-size: 12px; padding: 4px 10px;">Generate Missing</button>
        </div>
        <div id="generate-titles-status" style="margin-top: 6px; font-size: 11px; color: var(--text-muted); line-height: 1.4; min-height: 1em;"></div>
      </div>
    </div>
  </div>
</header>

<!-- Instructions Editor Modal -->
<div id="instructions-modal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4">
  <div class="modal-card" style="max-width: 720px; width: 100%; max-height: 90vh; display: flex; flex-direction: column;">
    <div class="p-6" style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
        <h3 style="font-size: 16px; font-weight: 600; margin: 0;">Workspace CLAUDE.md</h3>
        <button onclick="closeInstructionsEditor()" style="background:none;border:none;cursor:pointer;font-size:20px;color:var(--text-muted); line-height:1;">&times;</button>
      </div>
      <div id="instructions-path" style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px; font-family: monospace; word-break: break-all;"></div>
      <textarea id="instructions-content" rows="22" class="field" style="font-family: 'SF Mono','Fira Code','Consolas',monospace; font-size: 12px; flex: 1; min-height: 0; resize: none;"></textarea>
      <div style="display: flex; align-items: center; gap: 8px; margin-top: 12px;">
        <button onclick="saveInstructions()" class="btn btn-accent">Save</button>
        <button onclick="closeInstructionsEditor()" class="btn-ghost">Cancel</button>
        <button onclick="reinitInstructionsFromEditor()" class="btn-icon" style="margin-left: 8px; font-size: 12px; padding: 4px 10px;">Re-init from repos</button>
        <span id="instructions-status" style="font-size: 12px; color: var(--text-muted); margin-left: auto;"></span>
      </div>
    </div>
  </div>
</div>

<!-- Board -->
<main class="grid grid-cols-5 gap-4 p-6 flex-1 min-h-0" id="board">
  <div class="flex flex-col min-h-0">
    <div class="flex items-center gap-2 mb-3 px-1">
      <h2 class="col-header col-header-backlog">Backlog</h2>
      <span id="count-backlog" class="text-xs text-v-muted">0</span>
    </div>
    <button id="new-task-btn" onclick="showNewTaskForm()" class="btn-dashed mb-2">+ New Task</button>
    <div id="new-task-form" class="hidden mb-2">
      <textarea id="new-prompt" rows="4" placeholder="Describe your task (Markdown supported)..." class="field"></textarea>
      <div class="flex items-center justify-between mt-2">
        <div class="flex items-center gap-1">
          <button onclick="createTask()" class="btn btn-accent">Save</button>
          <button onclick="hideNewTaskForm()" class="btn-ghost">Cancel</button>
        </div>
        <select id="new-timeout" class="select" title="Timeout">
          <option value="5">5 min</option>
          <option value="15">15 min</option>
          <option value="30">30 min</option>
          <option value="60">1 hour</option>
          <option value="120">2 hours</option>
          <option value="360">6 hours</option>
          <option value="720">12 hours</option>
          <option value="1440">24 hours</option>
        </select>
      </div>
    </div>
    <div id="col-backlog" class="column col-bg space-y-2" data-status="backlog"></div>
  </div>
  <div class="flex flex-col min-h-0">
    <div class="flex items-center gap-2 mb-3 px-1">
      <h2 class="col-header col-header-progress">In Progress</h2>
      <span id="count-in_progress" class="text-xs text-v-muted">0</span>
    </div>
    <div id="col-in_progress" class="column col-bg space-y-2" data-status="in_progress"></div>
  </div>
  <div class="flex flex-col min-h-0">
    <div class="flex items-center gap-2 mb-3 px-1">
      <h2 class="col-header col-header-waiting">Waiting</h2>
      <span id="count-waiting" class="text-xs text-v-muted">0</span>
    </div>
    <div id="col-waiting" class="column col-bg space-y-2" data-status="waiting"></div>
  </div>
  <div class="flex flex-col min-h-0">
    <div class="flex items-center gap-2 mb-3 px-1">
      <h2 class="col-header col-header-done">Done</h2>
      <span id="count-done" class="text-xs text-v-muted">0</span>
      <span id="done-stats" class="text-[10px] text-v-muted hidden"></span>
    </div>
    <div id="col-done" class="column col-bg space-y-2" data-status="done"></div>
  </div>
  <div class="flex flex-col min-h-0">
    <div class="flex items-center gap-2 mb-3 px-1">
      <h2 class="col-header col-header-cancelled">Cancelled</h2>
      <span id="count-cancelled" class="text-xs text-v-muted">0</span>
    </div>
    <div id="col-cancelled" class="column col-bg space-y-2" data-status="cancelled"></div>
  </div>
</main>

<!-- Alert Modal -->
<div id="alert-modal" class="modal-overlay fixed inset-0 z-[60] hidden items-center justify-center p-4">
  <div class="modal-card" style="max-width: 420px; width: 100%;">
    <div class="p-6">
      <div class="flex items-start gap-3 mb-4">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #e05252; flex-shrink: 0; margin-top: 1px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
        <p id="alert-message" class="text-sm" style="color: var(--text-primary); margin: 0; line-height: 1.5;"></p>
      </div>
      <div style="display: flex; justify-content: flex-end;">
        <button id="alert-ok-btn" onclick="closeAlert()" class="btn btn-accent">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Detail Modal -->
<div id="modal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4">
  <div class="modal-card">
    <div class="p-6">
      <div class="flex items-start justify-between mb-4">
        <div class="flex items-center gap-3">
          <span id="modal-badge" class="badge"></span>
          <span id="modal-time" class="text-xs text-v-muted"></span>
          <span id="modal-id" class="text-xs text-v-muted font-mono" title="Task ID"></span>
        </div>
        <button onclick="closeModal()" class="text-v-muted text-xl leading-none" style="background:none;border:none;cursor:pointer;font-size:20px;">&times;</button>
      </div>

      <div id="modal-body">
        <div id="modal-left">
          <div class="flex items-center justify-between mb-2">
            <h3 class="section-title" style="margin-bottom:0;">Prompt</h3>
            <div id="modal-prompt-actions" class="flex items-center gap-1.5 hidden">
              <button id="copy-prompt-btn" onclick="copyModalText('prompt')" class="btn-icon" title="Copy to clipboard">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                Copy
              </button>
              <button id="toggle-prompt-btn" onclick="toggleModalSection('prompt')" class="btn-icon">Raw</button>
            </div>
          </div>
          <div id="modal-prompt-rendered" class="code-block mb-4 prose-content hidden"></div>
          <pre id="modal-prompt" class="code-block mb-4 hidden"></pre>

          <!-- Editable prompt/timeout for backlog tasks -->
          <div id="modal-edit-section" class="hidden mb-4">
            <textarea id="modal-edit-prompt" rows="4" class="field"></textarea>
            <div class="flex items-center gap-2 mt-2">
              <span id="modal-edit-status" class="text-xs text-v-muted"></span>
              <div class="ml-auto flex items-center gap-1.5">
                <label for="modal-edit-timeout" class="text-xs text-v-muted">Timeout</label>
                <select id="modal-edit-timeout" class="select">
                  <option value="5">5 min</option>
                  <option value="15">15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">1 hour</option>
                  <option value="120">2 hours</option>
                  <option value="360">6 hours</option>
                  <option value="720">12 hours</option>
                  <option value="1440">24 hours</option>
                </select>
              </div>
            </div>
            <div id="modal-edit-resume-row" class="hidden flex items-center gap-2 mt-2">
              <input type="checkbox" id="modal-edit-resume" onchange="saveResumeOption(this.checked)" style="cursor:pointer;accent-color:var(--accent);">
              <label for="modal-edit-resume" class="text-xs text-v-secondary" style="cursor:pointer;">Resume previous session</label>
            </div>
          </div>

          <!-- Prompt history (collapsible) -->
          <div id="modal-history-section" class="hidden mb-4">
            <details>
              <summary class="text-sm font-medium text-v-muted" style="cursor:pointer;">Prompt History</summary>
              <div id="modal-history-list" class="mt-2 space-y-2"></div>
            </details>
          </div>

          <!-- Resume section for failed tasks with session_id -->
          <div id="modal-resume-section" class="hidden mb-4">
            <h3 class="section-title">Resume Session</h3>
            <p class="text-sm text-v-secondary mb-2">This task has an active session. Resume to continue from where it left off.</p>
            <button onclick="resumeTask()" class="btn btn-green">Resume</button>
          </div>

          <!-- Retry section for done/failed/cancelled tasks -->
          <div id="modal-retry-section" class="hidden mb-4">
            <h3 class="section-title">Retry</h3>
            <textarea id="modal-retry-prompt" rows="4" class="field"></textarea>
            <button onclick="retryTask()" class="btn btn-accent mt-2">Move to Backlog</button>
          </div>

          <div id="modal-result-section" class="hidden">
            <div class="flex items-center justify-between mb-2">
              <h3 class="section-title" style="margin-bottom:0;">Result</h3>
              <div class="flex items-center gap-1.5">
                <button id="copy-result-btn" onclick="copyModalText('result')" class="btn-icon" title="Copy to clipboard">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                  Copy
                </button>
                <button id="toggle-result-btn" onclick="toggleModalSection('result')" class="btn-icon">Raw</button>
              </div>
            </div>
            <div id="modal-result-rendered" class="code-block mb-4 prose-content"></div>
            <pre id="modal-result" class="code-block mb-4 hidden"></pre>
          </div>

          <!-- Usage stats -->
          <div id="modal-usage-section" class="hidden mb-4">
            <h3 class="section-title">Usage</h3>
            <div class="usage-grid">
              <div class="flex justify-between"><span class="usage-label">Input tokens</span><span id="modal-usage-input" class="usage-value"></span></div>
              <div class="flex justify-between"><span class="usage-label">Output tokens</span><span id="modal-usage-output" class="usage-value"></span></div>
              <div class="flex justify-between"><span class="usage-label">Cache read</span><span id="modal-usage-cache-read" class="usage-value"></span></div>
              <div class="flex justify-between"><span class="usage-label">Cache creation</span><span id="modal-usage-cache-creation" class="usage-value"></span></div>
              <div class="flex justify-between" style="grid-column: span 2; padding-top: 4px; border-top: 1px solid var(--border); margin-top: 4px;"><span class="usage-label">Cost</span><span id="modal-usage-cost" class="usage-value"></span></div>
            </div>
          </div>

          <!-- Live logs for in-progress tasks -->
          <div id="modal-logs-section" class="hidden mb-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="section-title" style="margin-bottom:0;">Live Output</h3>
              <button id="toggle-logs-btn" onclick="toggleLogsMode()" class="btn-icon">Raw</button>
            </div>
            <pre id="modal-logs" class="logs-block"></pre>
          </div>

          <!-- Feedback form for waiting tasks -->
          <div id="modal-feedback-section" class="hidden mb-4">
            <h3 class="section-title">Provide Feedback</h3>
            <textarea id="modal-feedback" rows="3" placeholder="Type your response..." class="field"></textarea>
            <div class="flex items-center gap-2 mt-2">
              <button onclick="submitFeedback()" class="btn btn-yellow">Submit Feedback</button>
              <button onclick="completeTask()" class="btn btn-green">Mark as Done</button>
            </div>
          </div>

          <!-- Events timeline -->
          <h3 class="section-title">Events</h3>
          <div id="modal-events" class="space-y-2"></div>

          <!-- Archive section (done tasks only, not yet archived) -->
          <div id="modal-archive-section" class="hidden mb-4">
            <h3 class="section-title">Archive</h3>
            <p class="text-sm text-v-secondary mb-2">Hide this task from the Done column. It can be restored from Settings &rarr; Show archived tasks.</p>
            <button onclick="archiveTask()" class="btn btn-ghost" style="border: 1px solid var(--border);">Archive task</button>
          </div>

          <!-- Unarchive section (archived done tasks) -->
          <div id="modal-unarchive-section" class="hidden mb-4">
            <h3 class="section-title">Archived</h3>
            <p class="text-sm text-v-secondary mb-2">This task is archived and hidden from the Done column by default.</p>
            <button onclick="unarchiveTask()" class="btn btn-ghost" style="border: 1px solid var(--border);">Unarchive task</button>
          </div>

          <!-- Cancel section (backlog / in_progress / waiting / failed) -->
          <div id="modal-cancel-section" class="hidden mb-4">
            <h3 class="section-title">Cancel Task</h3>
            <p class="text-sm text-v-secondary mb-2">Discard all prepared changes and move this task to Cancelled. History and logs are preserved so the task can be retried later.</p>
            <button onclick="cancelTask()" class="btn btn-ghost" style="border: 1px solid var(--border); color: #a02828;">Cancel task</button>
          </div>

          <!-- Delete button -->
          <div class="mt-6 pt-4" style="border-top: 1px solid var(--border);">
            <button onclick="deleteCurrentTask()" class="btn-danger">Delete task</button>
          </div>
        </div>

        <!-- Right panel: diff for waiting/failed tasks with worktrees -->
        <div id="modal-right" class="hidden">
          <h3 class="section-title">Changes</h3>
          <div id="modal-diff-behind" class="hidden"></div>
          <div id="modal-diff-files"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/js/state.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/markdown.js"></script>
<script src="/js/theme.js"></script>
<script src="/js/api.js"></script>
<script src="/js/tasks.js"></script>
<script src="/js/render.js"></script>
<script src="/js/modal.js"></script>
<script src="/js/git.js"></script>
<script src="/js/dnd.js"></script>
<script src="/js/events.js"></script>
<script src="/js/instructions.js"></script>
</body>
</html>
