# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Wallfacer is a Kanban task runner for Claude Code. It provides a web UI where tasks are created as cards, dragged to "In Progress" to trigger Claude Code execution in an isolated sandbox container, and results are inspected when done.

**Architecture:** Browser → Go server (:8080) → per-task directory storage (`data/<uuid>/`). The server runs natively on the host and launches ephemeral sandbox containers via `os/exec` (podman/docker). Each task gets its own git worktree for isolation.

For detailed documentation see `docs/`.

## Build & Run Commands

```bash
make build          # Build the wallfacer sandbox image
make server         # Build and run the Go server natively
make shell          # Open bash shell in sandbox container for debugging
make clean          # Remove the sandbox image
make run PROMPT="…" # Headless one-shot Claude execution with a prompt
```

CLI usage (after `go build -o wallfacer .`):

```bash
wallfacer                                    # Print help
wallfacer run ~/project1 ~/project2          # Mount workspaces, open browser
wallfacer run                                # Defaults to current directory
wallfacer run -addr :9090 -no-browser        # Custom port, no browser
wallfacer env                                # Show config and env status
```

The Makefile uses Podman (`/opt/podman/bin/podman`) by default. Adjust `PODMAN` variable if using Docker.

## Server Development

The Go source lives at the top level. Module path: `changkun.de/wallfacer`. Go version: 1.25.7.

```bash
go build -o wallfacer .   # Build server binary
go vet ./...              # Lint
```

The server uses `net/http` stdlib routing (Go 1.22+ pattern syntax) with no framework.

Key server files:
- `main.go` — Subcommand dispatch, CLI flags, workspace resolution, HTTP routing, browser launch
- `server.go` — HTTP server setup, mux construction, route registration
- `internal/handler/` — HTTP API handlers (one file per concern: tasks, env, config, git, instructions, containers, stream)
- `internal/runner/` — Container orchestration via `os/exec`; task execution loop; commit pipeline; usage tracking; worktree sync
- `internal/store/` — Per-task directory persistence, data models (Task, TaskUsage, TaskEvent), event sourcing
- `internal/envconfig/` — `.env` file parsing and atomic update; exposes `Parse` and `Update` for the handler and runner
- `internal/instructions/` — Workspace-level CLAUDE.md management (`~/.wallfacer/instructions/`)
- `ui/index.html` + `ui/js/` — Kanban board UI (vanilla JS + Tailwind CSS CDN + Sortable.js)

## API Routes

See `docs/orchestration.md` for full details.

- `GET /` — Kanban UI
- `GET /api/config` — Server config (workspaces, instructions path)
- `GET /api/tasks` — List all tasks
- `POST /api/tasks` — Create task (JSON: `{prompt, timeout}`)
- `PATCH /api/tasks/{id}` — Update status/position/prompt/timeout/fresh_start
- `DELETE /api/tasks/{id}` — Delete task
- `POST /api/tasks/{id}/feedback` — Submit feedback for waiting tasks
- `POST /api/tasks/{id}/done` — Mark waiting task as done (triggers commit-and-push)
- `POST /api/tasks/{id}/cancel` — Cancel task; discard worktrees; move to Cancelled
- `POST /api/tasks/{id}/resume` — Resume failed task with existing session
- `POST /api/tasks/{id}/sync` — Rebase task worktrees onto latest default branch
- `POST /api/tasks/{id}/archive` — Move done task to archived
- `POST /api/tasks/{id}/unarchive` — Restore archived task
- `GET /api/tasks/stream` — SSE: push task list on state change
- `GET /api/tasks/{id}/events` — Task event timeline
- `GET /api/tasks/{id}/diff` — Git diff for task worktrees vs default branch
- `GET /api/tasks/{id}/outputs/{filename}` — Raw Claude Code output per turn
- `GET /api/tasks/{id}/logs` — SSE: stream live container logs
- `GET /api/git/status` — Git status for all workspaces
- `GET /api/git/stream` — SSE: git status updates
- `POST /api/git/push` — Push a workspace
- `GET /api/env` — Get env config (tokens masked); JSON: `{oauth_token, api_key, base_url, model}`
- `PUT /api/env` — Update env config; JSON: `{oauth_token?, api_key?, base_url?, model?}`; omitted/empty token fields are preserved
- `GET /api/instructions` — Get workspace CLAUDE.md content
- `PUT /api/instructions` — Save workspace CLAUDE.md (JSON: `{content}`)
- `POST /api/instructions/reinit` — Rebuild workspace CLAUDE.md from default + repo files

## Task Lifecycle

States: `backlog` → `in_progress` → `done` | `waiting` | `failed` | `cancelled` | `archived`

See `docs/task-lifecycle.md` for the full state machine, turn loop, and data models.

- Drag Backlog → In Progress triggers `runner.Run()` in a background goroutine
- Claude `end_turn` → commit pipeline → Done
- Empty stop_reason → Waiting (needs user feedback)
- `max_tokens`/`pause_turn` → auto-continue in same session
- Feedback on Waiting → resumes execution
- "Mark as Done" on Waiting → Done + auto commit-and-push
- "Cancel" on Backlog/In Progress/Waiting/Failed → Cancelled; kills container, discards worktrees
- "Resume" on Failed → continues in existing session
- "Retry" on Failed/Done/Cancelled → resets to Backlog with fresh session
- "Sync" on Waiting/Failed → rebases worktrees onto latest default branch without merging

## Key Conventions

- **UUIDs** for all task IDs (auto-generated via `github.com/google/uuid`)
- **Event sourcing** via per-task trace files; types: `state_change`, `output`, `feedback`, `error`
- **Per-task directory storage** with atomic writes (temp file + rename); `sync.RWMutex` for concurrency
- **Git worktrees** per task for isolation; see `docs/git-worktrees.md`
- **Usage tracking** accumulates input/output tokens, cache tokens, and cost across turns
- **Container execution** creates ephemeral containers via `os/exec`; mounts worktrees under `/workspace/<basename>`
- **Workspace CLAUDE.md** mounted read-only at `/workspace/CLAUDE.md` so Claude Code picks it up automatically
- **Frontend** uses SSE for live updates; escapes HTML to prevent XSS
- **No framework** on backend (stdlib `net/http`) or frontend (vanilla JS)

## Workspace CLAUDE.md (Instructions)

Each unique combination of workspace directories gets its own `CLAUDE.md` in `~/.wallfacer/instructions/`.
The file is identified by a SHA-256 fingerprint of the sorted workspace paths, so `wallfacer run ~/a ~/b` and `wallfacer run ~/b ~/a` share the same file.

On first run the file is created from:
1. A default wallfacer template (defined in `instructions.go`).
2. Any `CLAUDE.md` found at the root of each workspace directory (appended in order).

Users can manually edit the file from **Settings → CLAUDE.md → Edit** in the UI, or regenerate it from the repo files at any time with **Re-init**. The file is mounted read-only into every task container at `/workspace/CLAUDE.md`.

## Configuration

See `docs/architecture.md#configuration` for the full reference.

`~/.wallfacer/.env` must contain at least one of:
- `CLAUDE_CODE_OAUTH_TOKEN` — OAuth token from `claude setup-token`
- `ANTHROPIC_API_KEY` — direct API key from console.anthropic.com

Optional variables (also in `.env`):
- `ANTHROPIC_BASE_URL` — custom API endpoint; passed to the container via `--env-file`
- `CLAUDE_CODE_MODEL` — model override; the server reads this at each container launch and passes it as `--model` to `claude`

All four can be edited from **Settings → API Configuration** in the UI (calls `PUT /api/env`).
